<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <title> BlinkPro Master Panel</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
      body {
        font-family: "Segoe UI", sans-serif;
        background: linear-gradient(135deg, #0f172a, #1e293b, #0f172a);
        background-size: 400% 400%;
        animation: gradientMove 10s ease infinite;
        color: #e2e8f0;
        margin: 0;
        padding: 20px;
      }
      @keyframes gradientMove {
        0% { background-position: 0% 50%; }
        50% { background-position: 100% 50%; }
        100% { background-position: 0% 50%; }
      }
      h1 {
        color: #38bdf8;
        text-align: center;
        margin-bottom: 10px;
        font-size: 2rem;
        letter-spacing: 1px;
        text-shadow: 0 0 8px #00bcd4;
      }
      .indicators {
        display: flex;
        justify-content: center;
        gap: 20px;
        flex-wrap: wrap;
        margin-bottom: 25px;
      }
      .card {
        background: rgba(27, 31, 39, 0.85);
        border: 1px solid rgba(56, 189, 248, 0.4);
        box-shadow: 0 0 10px rgba(56, 189, 248, 0.3);
        border-radius: 10px;
        padding: 16px 20px;
        min-width: 150px;
        text-align: center;
        transition: transform 0.2s ease, box-shadow 0.3s ease;
      }
      .card:hover { transform: scale(1.05); box-shadow: 0 0 15px rgba(56, 189, 248, 0.6); }
      .card-title { font-size: 0.9rem; color: #94a3b8; }
      .card-value { font-size: 1.6rem; font-weight: bold; color: #22d3ee; text-shadow: 0 0 8px #22d3ee; }

      @keyframes pulseAmber { 0%, 100% { opacity: 0.8; text-shadow: 0 0 8px #f59e0b; } 50% { opacity: 1; text-shadow: 0 0 20px #fbbf24; } }
      @keyframes pulseRed { 0%, 100% { opacity: 0.8; text-shadow: 0 0 8px #ef4444; } 50% { opacity: 1; text-shadow: 0 0 20px #f87171; } }
      .pulse-amber { animation: pulseAmber 2s infinite ease-in-out; }
      .pulse-red { animation: pulseRed 1.8s infinite ease-in-out; }

      table {
        width: 100%;
        border-collapse: collapse;
        background: rgba(27, 31, 39, 0.9);
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
      }
      th, td { padding: 14px; text-align: center; }
      th { background: rgba(38, 50, 56, 0.9); color: #00bcd4; font-weight: 600; }
      tr:hover { background: rgba(56, 70, 90, 0.4); transform: scale(1.01); }
      .status { font-size: 20px; font-weight: bold; }
      .online { color: #4caf50; animation: blinkGreen 2s infinite; }
      .offline { color: #f44336; animation: blinkRed 2s infinite; }
      @keyframes blinkGreen { 0%, 100% { opacity: 0.7; } 50% { opacity: 1; } }
      @keyframes blinkRed { 0%, 100% { opacity: 0.7; } 50% { opacity: 1; } }

      .progress-bar { width: 100%; height: 10px; border-radius: 5px; background: rgba(80, 90, 110, 0.5); overflow: hidden; margin-top: 6px; }
      .progress-fill { height: 100%; border-radius: 5px; background: linear-gradient(90deg, #10b981, #22d3ee); transition: width 0.6s ease; }

      .ota { max-width: 1000px; margin: 30px auto; background: rgba(27,31,39,.9); border-radius: 12px; padding: 16px; box-shadow: 0 8px 25px rgba(0,0,0,.3); text-align:center; }
      .ota h2 { text-align:center; color:#38bdf8; margin: 0 0 10px; }
      .ota form { display:flex; gap:8px; justify-content:center; flex-wrap:wrap; }
      .ota input { padding:10px; border-radius:8px; border:1px solid #38bdf8; background:#0f172a; color:#e2e8f0; }
      .ota button { padding:10px 18px; border:none; border-radius:8px; background:#38bdf8; color:#0f172a; cursor:pointer; font-weight:600; }
      .ota .hint { text-align:center; color:#94a3b8; margin-top:10px; font-size:.9rem; }
      .badge { display:inline-block; padding:2px 8px; border-radius:999px; background:#0ea5e9; color:#001018; font-weight:700; margin-left:6px;}
      .filter-btn { margin-top:10px; padding:8px 16px; border:none; border-radius:8px; background:#10b981; color:#001018; font-weight:600; cursor:pointer; }
      .filter-btn.off { background:#334155; color:#94a3b8; }
    </style>
  </head>

  <body>
    <h1> BlinkPro Master Panel</h1>

    <div class="ota">
      <h2> Subir actualizaci贸n OTA <span id="latestBadge" class="badge" style="display:none"></span></h2>
      <form id="uploadForm" enctype="multipart/form-data">
        <input id="versionInput" type="text" placeholder="Versi贸n (ej. 1.2.0)" />
        <input id="apkInput" type="file" accept=".apk" />
        <button type="submit">Subir y publicar</button>
      </form>
      <div class="hint">El archivo se subir谩 al servidor y se notificar谩 a todos los dispositivos autom谩ticamente.</div>
    </div>

    <div class="indicators">
      <div class="card"><div class="card-title"> Usuarios en l铆nea</div><div class="card-value" id="onlineValue">0</div></div>
      <div class="card"><div class="card-title"> Total detectados</div><div class="card-value" id="totalValue">0</div></div>
      <div class="card"><div class="card-title">З Desactualizados</div><div class="card-value" id="outdatedValue">0</div></div>
    </div>

    <table id="devicesTable">
      <thead>
        <tr><th>Estado</th><th>Modelo</th><th>SDK</th><th>Versi贸n instalada</th><th>ltimo reporte</th></tr>
      </thead>
      <tbody></tbody>
    </table>

    <script>
      const ws = new WebSocket("wss://blinkpro-master.onrender.com/ws?key=panel");
      let devicesData = {}, latestVersion = null;

      ws.onmessage = (e) => {
        const msg = JSON.parse(e.data);
        if (msg.type === "updateDevices") {
          devicesData = msg.devices || {};
          renderDevices();
        }
        if (msg.type === "newUpdate") setLatestBadge(msg);
      };

      function renderDevices() {
        const tbody = document.querySelector("#devicesTable tbody");
        tbody.innerHTML = "";
        Object.values(devicesData).forEach((d) => {
          const row = `<tr>
            <td class="${d.online ? "online" : "offline"}">${d.online ? "" : ""}</td>
            <td>${d.model}</td>
            <td>${d.sdk}</td>
            <td>${d.version}</td>
            <td>${d.lastSeen}</td>
          </tr>`;
          tbody.insertAdjacentHTML("beforeend", row);
        });
        document.getElementById("onlineValue").textContent = Object.values(devicesData).filter(d=>d.online).length;
        document.getElementById("totalValue").textContent = Object.keys(devicesData).length;
      }

      function setLatestBadge(data) {
        if (data?.version && data.version !== "none") {
          latestVersion = data.version;
          const b = document.getElementById("latestBadge");
          b.style.display = "inline-block";
          b.textContent = `v${data.version}`;
        }
      }

      document.getElementById("uploadForm").addEventListener("submit", async (e) => {
        e.preventDefault();
        const version = document.getElementById("versionInput").value.trim();
        const file = document.getElementById("apkInput").files[0];
        if (!version || !file) return alert("Completa versi贸n y selecciona un archivo .apk");

        const fd = new FormData();
        fd.append("apk", file);
        fd.append("version", version);

        const up = await fetch("/api/upload", { method: "POST", body: fd });
        const msg = await up.text();
        alert(msg);
      });

      fetch("/api/update").then(r=>r.json()).then(setLatestBadge);
    </script>
  </body>
</html>
