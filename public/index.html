<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <title>ðŸ“¡ BlinkPro Master Panel</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
      body {
        font-family: "Segoe UI", sans-serif;
        background: linear-gradient(135deg, #0f172a, #1e293b, #0f172a);
        background-size: 400% 400%;
        animation: gradientMove 10s ease infinite;
        color: #e2e8f0;
        margin: 0;
        padding: 20px;
      }
      @keyframes gradientMove {
        0% { background-position: 0% 50%; }
        50% { background-position: 100% 50%; }
        100% { background-position: 0% 50%; }
      }
      h1 {
        color: #38bdf8;
        text-align: center;
        margin-bottom: 10px;
        font-size: 2rem;
        letter-spacing: 1px;
        text-shadow: 0 0 8px #00bcd4;
      }
      .indicators {
        display: flex;
        justify-content: center;
        gap: 20px;
        flex-wrap: wrap;
        margin-bottom: 25px;
      }
      .card {
        background: rgba(27, 31, 39, 0.85);
        border: 1px solid rgba(56, 189, 248, 0.4);
        box-shadow: 0 0 10px rgba(56, 189, 248, 0.3);
        border-radius: 10px;
        padding: 16px 20px;
        min-width: 150px;
        text-align: center;
        transition: transform 0.2s ease, box-shadow 0.3s ease;
      }
      .card:hover { transform: scale(1.05); box-shadow: 0 0 15px rgba(56, 189, 248, 0.6); }
      .card-title { font-size: 0.9rem; color: #94a3b8; }
      .card-value { font-size: 1.6rem; font-weight: bold; color: #22d3ee; text-shadow: 0 0 8px #22d3ee; }

      table {
        width: 100%;
        border-collapse: collapse;
        background: rgba(27, 31, 39, 0.9);
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
      }
      th, td { padding: 14px; text-align: center; }
      th { background: rgba(38, 50, 56, 0.9); color: #00bcd4; font-weight: 600; }
      tr:hover { background: rgba(56, 70, 90, 0.4); transform: scale(1.01); }
      .online { color: #4caf50; animation: blinkGreen 2s infinite; }
      .offline { color: #f44336; animation: blinkRed 2s infinite; }
      @keyframes blinkGreen { 0%,100%{opacity:.7;}50%{opacity:1;} }
      @keyframes blinkRed { 0%,100%{opacity:.7;}50%{opacity:1;} }

      .ota {
        max-width: 1000px; margin: 30px auto;
        background: rgba(27,31,39,.9); border-radius: 12px;
        padding: 16px; box-shadow: 0 8px 25px rgba(0,0,0,.3); text-align:center;
      }
      .ota h2 { color:#38bdf8; margin: 0 0 10px; }
      .ota form { display:flex; gap:8px; justify-content:center; flex-wrap:wrap; }
      .ota input {
        padding:10px; border-radius:8px;
        border:1px solid #38bdf8; background:#0f172a; color:#e2e8f0;
      }
      .ota button {
        padding:10px 18px; border:none; border-radius:8px;
        background:#38bdf8; color:#0f172a; cursor:pointer; font-weight:600;
      }
      .ota .hint { color:#94a3b8; margin-top:10px; font-size:.9rem; }
      .badge { display:inline-block; padding:2px 8px; border-radius:999px;
        background:#0ea5e9; color:#001018; font-weight:700; margin-left:6px;}

      /* ðŸ”” Toasts */
      #toast-container {
        position: fixed;
        bottom: 30px;
        right: 30px;
        display: flex;
        flex-direction: column;
        gap: 10px;
        z-index: 9999;
      }
      .toast {
        background: rgba(56,189,248,0.15);
        border-left: 5px solid #38bdf8;
        padding: 14px 18px;
        border-radius: 8px;
        color: #e2e8f0;
        font-size: 0.95rem;
        box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        min-width: 260px;
        animation: fadeIn 0.3s ease;
      }
      .toast.success { border-color: #10b981; }
      .toast.error { border-color: #ef4444; }
      .toast .progress {
        height: 6px;
        border-radius: 3px;
        background: rgba(255,255,255,0.15);
        margin-top: 8px;
        overflow: hidden;
      }
      .toast .progress-inner {
        height: 100%;
        width: 0%;
        background: linear-gradient(90deg,#10b981,#22d3ee);
        transition: width 0.2s linear;
      }
      @keyframes fadeIn { from{opacity:0;transform:translateY(10px);}to{opacity:1;transform:translateY(0);} }
    </style>
  </head>

  <body>
    <h1>ðŸ“¡ BlinkPro Master Panel</h1>

    <div class="ota">
      <h2>ðŸš€ Subir actualizaciÃ³n OTA <span id="latestBadge" class="badge" style="display:none"></span></h2>
      <form id="uploadForm" enctype="multipart/form-data">
        <input id="versionInput" type="text" placeholder="VersiÃ³n (ej. 1.2.0)" />
        <input id="apkInput" type="file" accept=".apk" />
        <button type="submit">Subir y publicar</button>
      </form>
      <div class="hint">El archivo se subirÃ¡ al servidor y se notificarÃ¡ a todos los dispositivos automÃ¡ticamente.</div>
    </div>

    <div class="indicators">
      <div class="card"><div class="card-title">ðŸŸ¢ Usuarios en lÃ­nea</div><div class="card-value" id="onlineValue">0</div></div>
      <div class="card"><div class="card-title">ðŸ“± Total detectados</div><div class="card-value" id="totalValue">0</div></div>
      <div class="card"><div class="card-title">ðŸ§© Desactualizados</div><div class="card-value" id="outdatedValue">0</div></div>
    </div>

    <table id="devicesTable">
      <thead>
        <tr><th>Estado</th><th>Modelo</th><th>SDK</th><th>VersiÃ³n instalada</th><th>Ãšltimo reporte</th></tr>
      </thead>
      <tbody></tbody>
    </table>

    <div id="toast-container"></div>

    <script>
      const ws = new WebSocket("wss://blinkpro-master.onrender.com/ws?key=panel");
      let devicesData = {}, latestVersion = null;

      ws.onmessage = (e) => {
        const msg = JSON.parse(e.data);
        if (msg.type === "updateDevices") {
          devicesData = msg.devices || {};
          renderDevices();
        }
        if (msg.type === "newUpdate") {
          setLatestBadge(msg);
          showToast(`Nueva versiÃ³n publicada: v${msg.version}`, "success");
        }
      };

      function renderDevices() {
        const tbody = document.querySelector("#devicesTable tbody");
        tbody.innerHTML = "";
        Object.values(devicesData).forEach((d) => {
          tbody.insertAdjacentHTML("beforeend",
            `<tr>
              <td class="${d.online ? "online" : "offline"}">${d.online ? "ðŸŸ¢" : "ðŸ”´"}</td>
              <td>${d.model}</td>
              <td>${d.sdk}</td>
              <td>${d.version}</td>
              <td>${d.lastSeen}</td>
            </tr>`
          );
        });
        document.getElementById("onlineValue").textContent = Object.values(devicesData).filter(d=>d.online).length;
        document.getElementById("totalValue").textContent = Object.keys(devicesData).length;
      }

      function setLatestBadge(data) {
        if (data?.version && data.version !== "none") {
          latestVersion = data.version;
          const b = document.getElementById("latestBadge");
          b.style.display = "inline-block";
          b.textContent = `v${data.version}`;
        }
      }

      function showToast(message, type="info", withProgress=false) {
        const container = document.getElementById("toast-container");
        const toast = document.createElement("div");
        toast.className = `toast ${type}`;
        toast.innerHTML = `<div>${message}</div>`;
        if (withProgress) {
          const bar = document.createElement("div");
          bar.className = "progress";
          bar.innerHTML = `<div class="progress-inner"></div>`;
          toast.appendChild(bar);
        }
        container.appendChild(toast);
        return toast;
      }

      function updateProgressToast(toast, percent) {
        const inner = toast.querySelector(".progress-inner");
        if (inner) inner.style.width = percent + "%";
      }

      document.getElementById("uploadForm").addEventListener("submit", (e) => {
        e.preventDefault();
        const version = document.getElementById("versionInput").value.trim();
        const file = document.getElementById("apkInput").files[0];
        if (!version || !file) return showToast("Completa versiÃ³n y selecciona un archivo .apk", "error");

        const fd = new FormData();
        fd.append("apk", file);
        fd.append("version", version);

        const toast = showToast("Subiendo actualizaciÃ³n... 0%", "info", true);

        const xhr = new XMLHttpRequest();
        xhr.open("POST", "/api/upload", true);

        xhr.upload.onprogress = (evt) => {
          if (evt.lengthComputable) {
            const percent = Math.round((evt.loaded / evt.total) * 100);
            updateProgressToast(toast, percent);
            toast.firstChild.textContent = `Subiendo actualizaciÃ³n... ${percent}%`;
          }
        };

        xhr.onload = () => {
          if (xhr.status === 200) {
            toast.firstChild.textContent = "âœ… Subida completada y publicada correctamente";
            toast.classList.add("success");
            updateProgressToast(toast, 100);
          } else {
            toast.firstChild.textContent = "âŒ Error al subir APK: " + xhr.responseText;
            toast.classList.add("error");
          }
          setTimeout(()=>toast.remove(),4000);
        };

        xhr.onerror = () => {
          toast.firstChild.textContent = "ðŸš¨ Error de conexiÃ³n";
          toast.classList.add("error");
          setTimeout(()=>toast.remove(),4000);
        };

        xhr.send(fd);
      });

      fetch("/api/update").then(r=>r.json()).then(setLatestBadge);
    </script>
  </body>
</html>
